<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pembayaran QRIS - HandyMan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Modern -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        .qris-container {
            animation: slideUp 0.5s ease-out;
        }
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .qris-image {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-slate-100 min-h-screen flex items-center justify-center p-4">

    <!-- TOAST CONTAINER -->
    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-3 w-80 pointer-events-none"></div>

    <!-- MAIN CONTAINER -->
    <div class="w-full max-w-md">
        <div class="qris-container bg-white rounded-3xl shadow-2xl p-8 border border-slate-100">
            
            <!-- HEADER -->
            <div class="text-center mb-8">
                <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-100 rounded-full mb-4">
                    <i class="fa-solid fa-qrcode text-3xl text-blue-600"></i>
                </div>
                <h1 class="text-2xl font-bold text-slate-800 mb-2">Pembayaran QRIS</h1>
                <p class="text-sm text-slate-500">Scan QR Code di bawah dengan aplikasi pembayaran Anda</p>
            </div>

            <!-- INFO PESANAN -->
            <div id="order-info" class="bg-slate-50 rounded-xl p-4 mb-6 space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-slate-600">ID Pesanan:</span>
                    <span id="order-id" class="font-semibold text-slate-800">#-</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-slate-600">Kategori:</span>
                    <span id="order-category" class="font-semibold text-slate-800">-</span>
                </div>
                <div class="flex justify-between text-sm border-t border-slate-200 pt-2 mt-2">
                    <span class="text-slate-600 font-semibold">Total Pembayaran:</span>
                    <span id="order-amount" class="font-bold text-lg text-blue-600">Rp 0</span>
                </div>
            </div>

            <!-- QRIS IMAGE -->
            <div class="bg-white border-2 border-slate-200 rounded-2xl p-6 mb-6 flex items-center justify-center">
                <img id="qris-image" src="" alt="QRIS Payment" class="qris-image w-full max-w-xs">
            </div>

            <!-- INSTRUKSI PEMBAYARAN -->
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mb-6 space-y-3">
                <h3 class="font-semibold text-blue-900 flex items-center gap-2">
                    <i class="fa-solid fa-circle-info"></i> Cara Pembayaran:
                </h3>
                <ol class="text-sm text-blue-800 space-y-2 list-decimal list-inside">
                    <li>Buka aplikasi pembayaran digital (GCash, Dana, OVO, dll)</li>
                    <li>Pilih menu "Scan QR Code"</li>
                    <li>Arahkan kamera ke QR Code di atas</li>
                    <li>Konfirmasi nominal dan lakukan pembayaran</li>
                    <li>Simpan bukti pembayaran</li>
                </ol>
            </div>

            <!-- NOMINAL PEMBAYARAN (OPSIONAL) -->
            <div class="mb-6">
                <label class="block text-sm font-medium text-slate-700 mb-2">Jumlah Pembayaran</label>
                <div class="relative">
                    <span class="absolute left-4 top-3 text-slate-600 font-semibold">Rp</span>
                    <input type="number" id="payment-amount" placeholder="Masukkan nominal" 
                           class="w-full pl-10 pr-4 py-3 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <p class="text-xs text-slate-500 mt-2">
                    ðŸ’¡ Nominal otomatis terisi dari pesanan. Ubah jika diperlukan.
                </p>
            </div>

            <!-- BUTTON ACTIONS -->
            <div class="space-y-3">
                <button id="confirm-payment-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition duration-200 flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check-circle"></i> Saya Sudah Membayar
                </button>
                <button onclick="goBack()" class="w-full border-2 border-slate-300 text-slate-700 hover:bg-slate-50 font-semibold py-3 rounded-xl transition duration-200">
                    <i class="fa-solid fa-arrow-left"></i> Kembali
                </button>
            </div>

            <!-- INFORMASI TAMBAHAN -->
            <div class="mt-6 pt-6 border-t border-slate-200">
                <p class="text-xs text-slate-500 text-center">
                    âœ“ Pembayaran aman dan terenkripsi<br>
                    âœ“ Dukungan 24/7 jika ada pertanyaan<br>
                    <span id="contact-info">ðŸ“ž Hub: +62 xxx xxxx xxxx</span>
                </p>
            </div>

        </div>

        <!-- FOOTER -->
        <div class="text-center mt-6 text-xs text-slate-600">
            <p>Powered by <span class="font-semibold text-slate-800">HandyMan Payment</span></p>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        const API_URL = 'http://localhost:3000/api';

        // Get order info from URL or localStorage
        document.addEventListener('DOMContentLoaded', async () => {
            const urlParams = new URLSearchParams(window.location.search);
            const orderId = urlParams.get('order_id');
            
            if (orderId) {
                // Fetch order data from API
                try {
                    const response = await fetch(`${API_URL}/pesanan/${orderId}`);
                    if (response.ok) {
                        const result = await response.json();
                        const order = result.data[0] || result.data;
                        
                        document.getElementById('order-id').textContent = '#' + order.id;
                        document.getElementById('order-category').textContent = order.kategori_jasa;
                        const amount = parseInt(order.harga) || 150000;
                        document.getElementById('order-amount').textContent = formatRupiah(amount);
                        document.getElementById('payment-amount').value = amount;
                        
                        // Load contact from QRIS settings
                        loadQRISSettings();
                        loadQRISImage();
                        return;
                    }
                } catch (error) {
                    console.error('Error loading order:', error);
                }
            }
            
            // Fallback: dari localStorage
            const orderData = {
                id: orderId || localStorage.getItem('current_order_id') || '12345',
                kategori: localStorage.getItem('current_order_category') || 'Perbaikan Umum',
                amount: parseInt(localStorage.getItem('current_order_amount')) || 150000
            };

            document.getElementById('order-id').textContent = '#' + orderData.id;
            document.getElementById('order-category').textContent = orderData.kategori;
            document.getElementById('order-amount').textContent = formatRupiah(orderData.amount);
            document.getElementById('payment-amount').value = orderData.amount;

            loadQRISSettings();
            loadQRISImage();
        });

        // Load QRIS Settings
        async function loadQRISSettings() {
            try {
                const response = await fetch(`${API_URL}/qris-settings`);
                if (response.ok) {
                    const result = await response.json();
                    const settings = result.data;
                    document.getElementById('contact-info').textContent = `ðŸ“ž Hub: ${settings.merchant_phone}`;
                }
            } catch (error) {
                console.error('Error loading QRIS settings:', error);
            }
        }

        // Load QRIS Image
        function loadQRISImage() {
            const qrisImg = document.getElementById('qris-image');
            // Load from uploads folder
            qrisImg.src = 'http://localhost:3000/uploads/qris-code.png';
            qrisImg.onerror = () => {
                // Fallback placeholder jika gambar tidak ditemukan
                qrisImg.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"%3E%3Crect fill="%23f0f0f0" width="200" height="200"/%3E%3Ctext x="50%" y="50%" font-size="14" fill="%23999" text-anchor="middle" dy=".3em"%3EQRIS Image%3C/text%3E%3C/svg%3E';
            };
        }

        // Format Rupiah
        function formatRupiah(amount) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0
            }).format(amount);
        }

        // Confirm Payment
        document.getElementById('confirm-payment-btn').addEventListener('click', async () => {
            const paymentAmountInput = document.getElementById('payment-amount').value;
            const orderIdText = document.getElementById('order-id').textContent;
            const orderId = orderIdText.replace('#', '');
            
            const amount = parseInt(paymentAmountInput);
            
            if (!orderId || orderId === '' || orderId === '-') {
                showToast('Order ID tidak valid', 'ERROR');
                return;
            }
            
            if (!amount || amount <= 0) {
                showToast('Masukkan nominal pembayaran yang valid', 'ERROR');
                return;
            }

            try {
                // Show confirmation
                if (!confirm(`Konfirmasi pembayaran Rp ${amount.toLocaleString('id-ID')}?\n\nPastikan Anda sudah melakukan transfer sebelum confirm.`)) {
                    return;
                }

                // Disable button during process
                const btn = document.getElementById('confirm-payment-btn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Memproses...';

                // Record payment first
                const paymentResponse = await fetch(`${API_URL}/payment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        pesanan_id: orderId,
                        payment_method: 'qris',
                        payment_amount: amount
                    })
                });

                const paymentResult = await paymentResponse.json();
                
                if (!paymentResult.success) {
                    throw new Error(paymentResult.message || 'Gagal mencatat pembayaran');
                }

                // Update order status to paid
                const updateResponse = await fetch(`${API_URL}/pesanan/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        status: 'dibayar',
                        payment_method: 'qris',
                        payment_amount: amount
                    })
                });

                const updateResult = await updateResponse.json();
                
                if (updateResult.success) {
                    showToast('âœ“ Pembayaran berhasil dicatat! Terima kasih.', 'SUCCESS');
                    setTimeout(() => {
                        window.location.href = 'Beranda.html';
                    }, 2000);
                } else {
                    throw new Error(updateResult.message || 'Gagal mengupdate status pesanan');
                }
            } catch (error) {
                console.error('Payment error:', error);
                showToast('Gagal: ' + error.message, 'ERROR');
                
                // Re-enable button
                const btn = document.getElementById('confirm-payment-btn');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        });

        // Go Back
        function goBack() {
            window.history.back();
        }

        // Toast Notification
        function showToast(msg, type) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            
            const div = document.createElement('div');
            const icon = type === 'SUCCESS' ? 'fa-circle-check text-green-500' : 'fa-circle-exclamation text-red-500';
            
            div.className = "bg-white p-4 rounded-lg shadow-lg border-l-4 border-green-500 flex items-center gap-3 animate-in";
            if (type === 'ERROR') div.classList.add('border-red-500');
            
            div.innerHTML = `<i class="fa-solid ${icon}"></i> <span class="text-sm font-medium text-slate-800">${msg}</span>`;
            container.appendChild(div);

            setTimeout(() => {
                div.remove();
            }, 4000);
        }
    </script>
</body>
</html>
